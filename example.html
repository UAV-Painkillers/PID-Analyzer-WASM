<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PID Analyzer</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="dist/index.js"></script>
  </head>
  <body>
    <script>
      function plotStepResponse(generalInformation, data) {
        const layout = {
          title: data.name + " step response",
          xaxis: {
            title: "response time in s",
            range: [-0.001, 0.501],
          },
          yaxis: {
            title: "strength",
            range: [0, 2],
          },
          showlegend: true,
        };

        const traceLow = {
          x: data.step_response.time_resp,
          y: data.step_response["resp_low[0]"],
          type: "scatter",
          mode: "lines",
          name:
            data.name +
            " step response " +
            "(<" +
            Math.round(data.global.threshold) +
            ")",
          line: {
            color: "blue",
          },
        };

        const plotData = [traceLow];

        if (data.step_response.high_mask_sum > 0) {
          const traceHigh = {
            x: data.step_response.time_resp,
            y: data.step_response["resp_high[0]"],
            type: "scatter",
            mode: "lines",
            name:
              data.name +
              " step response " +
              "(>" +
              Math.round(data.global.threshold) +
              ") " +
              " PID " +
              generalInformation[data.name + "PID"],
            line: {
              color: "orange",
            },
          };

          plotData.push(traceHigh);
        }

        Plotly.newPlot("step_response__" + data.name, plotData, layout);
      }

      async function main() {
        console.log("Loading data...");
        const logData = await fetch("temp/data.json").then((response) => response.json());

        console.log("Loading general information...");
        const generalInformation = await fetch("temp/headdict.json").then((response) =>
          response.json()
        );

        console.log("Calculating step responses...");
        const stepResponses = await PIDAnalyzer.stepResponse(generalInformation, logData);
        console.log("Step responses calculated.", stepResponses);

        console.log("Plotting step responses...");
        Object.values(stepResponses).forEach((response) => plotStepResponse(generalInformation, response));
      }      

      main();
    </script>

    <div id="step_response__roll"></div>
    <div id="step_response__pitch"></div>
    <div id="step_response__yaw"></div>
  </body>
</html>
